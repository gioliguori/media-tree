services:
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - media-tree
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  controller:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: controller
    ports:
      - "8080:8080"
    environment:
      SERVER_PORT: 8080
      DOCKER_NETWORK: media-tree
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      REDIS_DB: 0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - media-tree
    restart: unless-stopped

  whip-client-1:
    build:
      context: ../simple-whip-client
    container_name: whip-client-1
    environment:
      - URL=http://test-1-injection-1:7070/whip/endpoint/broadcaster-1
      - TOKEN=verysecret
      - AUDIO_PIPE=audiotestsrc is-live=true wave=sine freq=440 ! audioconvert ! audioresample ! queue ! opusenc ! rtpopuspay pt=111 ssrc=10000 ! queue ! application/x-rtp,media=audio,encoding-name=OPUS,payload=111
      - VIDEO_PIPE=videotestsrc is-live=true pattern=ball ! video/x-raw,width=640,height=480,framerate=30/1 ! videoconvert ! queue ! x264enc tune=zerolatency speed-preset=veryfast bitrate=2000 ! rtph264pay pt=96 ssrc=10001 config-interval=1 ! queue ! application/x-rtp,media=video,encoding-name=H264,payload=96
      - STUN_SERVER=stun://stun.l.google.com:19302
      - GST_DEBUG=2
    networks:
      - media-tree

  whip-client-2:
    build:
      context: ../simple-whip-client
      dockerfile: Dockerfile
    container_name: whip-client-2
    environment:
      - URL=http://test-1-injection-1:7070/whip/endpoint/broadcaster-auto
      - TOKEN=verysecret

      - AUDIO_PIPE=audiotestsrc is-live=true wave=sine freq=880 ! audioconvert ! audioresample ! queue ! opusenc ! rtpopuspay pt=111 ssrc=3333 ! queue ! application/x-rtp,media=audio,encoding-name=OPUS,payload=111
      - VIDEO_PIPE=videotestsrc is-live=true pattern=smpte ! video/x-raw,width=640,height=480,framerate=30/1 ! videoconvert ! queue ! x264enc tune=zerolatency speed-preset=ultrafast bitrate=2500 ! rtph264pay pt=96 ssrc=4444 config-interval=1 ! queue ! application/x-rtp,media=video,encoding-name=H264,payload=96
      - STUN_SERVER=stun://stun.l.google.com:19302
      - GST_DEBUG=2
    networks:
      - media-tree

networks:
  media-tree:
    name: media-tree
    driver: bridge
