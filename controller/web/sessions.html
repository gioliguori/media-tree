<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media - Global Sessions</title>
</head>

<body>
    <h1> Media Sessions</h1>

    <div class="mesh-status">
        Global Pool Status: <span id="node-count">...</span> Nodes Active
    </div>

    <div id="error" class="error"></div>
    <div id="loading" class="loading">Syncing...</div>
    <div id="sessions"></div>

    <script>
        window.onload = function () {
            loadSessions();
            loadNodeStats();
        };

        // Carica tutte le sessioni attive nella
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const sessions = await response.json();
                displaySessions(sessions);
                hideError();
            } catch (error) {
                showError(`Failed to load sessions: ${error.message}`);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Carica statistiche dei nodi
        async function loadNodeStats() {
            try {
                const response = await fetch('/api/nodes');
                if (response.ok) {
                    const nodes = await response.json();
                    document.getElementById('node-count').textContent = nodes.length;
                }
            } catch (e) { }
        }
        function displaySessions(sessions) {
            const container = document.getElementById('sessions');
            if (!sessions || sessions.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999;">No active broadcasts found.</p>';
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="session">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="session-id">${session.sessionId}</span>
                        <span class="badge ${session.active ? 'badge-active' : 'badge-inactive'}">
                            ${session.active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="info">Ingested via: <b>${session.injectionNodeId}</b></div>
                    <div class="info">Created: ${new Date(session.createdAt).toLocaleString()}</div>
                    <button onclick="watchSession('${session.sessionId}')" ${!session.active ? 'disabled' : ''}>
                        Watch Stream
                    </button>
                </div>
            `).join('');
        }

        async function watchSession(sessionId) {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Allocating Path...';

            try {
                const response = await fetch(`/api/sessions/${sessionId}/view`);
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Mesh Allocation Failed');
                }

                const data = await response.json();
                console.log('Path built:', data.path.join(' -> '));

                // Redirect al WHEP endpoint sull'Egress selezionato
                window.location.href = data.whepEndpoint;

            } catch (error) {
                showError(`Provisioning Error: ${error.message}`);
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        function showError(msg) {
            const div = document.getElementById('error');
            div.textContent = msg;
            div.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // Refresh automatico ogni 10 secondi
        setInterval(() => {
            if (!document.hidden) {
                loadSessions();
                loadNodeStats();
            }
        }, 10000);
    </script>
</body>
<style>
    body {
        font-family: monospace;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
    }

    h1 {
        color: #333;
        text-align: center;
    }

    .mesh-status {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
        text-align: center;
        color: #666;
    }

    .session {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .session-id {
        font-size: 18px;
        font-weight: bold;
        color: #0066cc;
    }

    .info {
        color: #666;
        font-size: 14px;
        margin: 5px 0;
    }

    .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .badge-active {
        background: #d4edda;
        color: #155724;
    }

    .badge-inactive {
        background: #f8d7da;
        color: #721c24;
    }

    button {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
        margin-top: 10px;
        width: 100%;
    }

    button:hover {
        background: #218838;
    }

    button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        margin: 10px 0;
        display: none;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }
</style>

</html>